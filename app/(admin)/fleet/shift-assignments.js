import {
  View,
  Text,
  ScrollView,
  TouchableOpacity,
  ActivityIndicator,
  RefreshControl,
  Animated,
  Modal,
} from "react-native";
import { useState, useEffect, useRef } from "react";
import { useRouter } from "expo-router";
import { SafeAreaView } from "react-native-safe-area-context";
import { Ionicons } from "@expo/vector-icons";
import Toast from "react-native-toast-message";
import { Picker } from "@react-native-picker/picker";
import { AutoShiftService } from "../../../services";
import apiClient from "../../../services/api/apiClient";
import { LinearGradient } from "expo-linear-gradient";

const TRIP_STATUS_STYLES = {
  pending: {
    label: "Pending",
    bg: "#FEF3C7",
    color: "#92400E",
    icon: "time-outline",
  },
  "in-progress": {
    label: "In Progress",
    bg: "#DBEAFE",
    color: "#1D4ED8",
    icon: "navigate-circle",
  },
  completed: {
    label: "Completed",
    bg: "#DCFCE7",
    color: "#166534",
    icon: "checkmark-circle",
  },
  cancelled: {
    label: "Cancelled",
    bg: "#FEE2E2",
    color: "#B91C1C",
    icon: "close-circle",
  },
  default: {
    label: "Unknown",
    bg: "#E5E7EB",
    color: "#374151",
    icon: "help-circle",
  },
};

const getLocationLabel = (location) => {
  if (!location) return "N/A";
  return (
    location.address ||
    location.name ||
    location.label ||
    [location.latitude, location.longitude]
      .filter((value) => typeof value === "number")
      .join(", ") ||
    "N/A"
  );
};

const getDriverNames = (assignment) => {
  if (assignment.drivers && assignment.drivers.length > 0) {
    return assignment.drivers.map((d) => d.name || "Unknown").join(", ");
  }
  if (assignment.driver) {
    return assignment.driver.name || "N/A";
  }
  return "N/A";
};

const formatTimeValue = (value) => {
  if (!value) return "Not started";
  try {
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) {
      return "Not started";
    }
    return date.toLocaleString("en-IN", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: true,
      day: "2-digit",
      month: "short",
    });
  } catch (error) {
    return "Not started";
  }
};

const TripStatusBadge = ({ status }) => {
  const style = TRIP_STATUS_STYLES[status] || TRIP_STATUS_STYLES.default;
  return (
    <View
      style={{
        backgroundColor: style.bg,
        paddingHorizontal: 12,
        paddingVertical: 6,
        borderRadius: 20,
        flexDirection: "row",
        alignItems: "center",
      }}
    >
      <Ionicons name={style.icon} size={12} color={style.color} />
      <Text
        style={{
          fontFamily: "Poppins",
          fontSize: 11,
          fontWeight: "600",
          color: style.color,
          marginLeft: 4,
        }}
      >
        {style.label}
      </Text>
    </View>
  );
};

// Stat Card Component
const StatCard = ({ icon, label, value, color, gradientColors }) => (
  <View className="flex-1 mx-1">
    <LinearGradient
      colors={gradientColors}
      start={{ x: 0, y: 0 }}
      end={{ x: 1, y: 1 }}
      className="rounded-2xl p-4 shadow-sm"
    >
      <View className="flex-row items-center justify-between mb-2">
        <View className="bg-white/20 p-2 rounded-full">
          <Ionicons name={icon} size={20} color="#fff" />
        </View>
      </View>
      <Text
        style={{
          fontFamily: "Poppins",
          fontSize: 24,
          fontWeight: "700",
          color: "#fff",
        }}
      >
        {value}
      </Text>
      <Text
        style={{
          fontFamily: "Poppins",
          fontSize: 12,
          color: "#fff",
          opacity: 0.9,
        }}
      >
        {label}
      </Text>
    </LinearGradient>
  </View>
);

// Assignment Card Component
const AssignmentCard = ({ assignment, onRelease }) => {
  const [expanded, setExpanded] = useState(false);
  const activeTrip =
    assignment.activeTrip ||
    (assignment.trips &&
      assignment.trips.find((trip) => trip.status === "in-progress"));

  return (
    <TouchableOpacity
      onPress={() => setExpanded(!expanded)}
      className="bg-white rounded-2xl mb-4 shadow-sm overflow-hidden"
      activeOpacity={0.7}
    >
      {/* Header */}
      <LinearGradient
        colors={
          assignment.autoGenerated
            ? ["#10B981", "#059669"]
            : ["#F59E0B", "#D97706"]
        }
        start={{ x: 0, y: 0 }}
        end={{ x: 1, y: 0 }}
        className="p-4"
      >
        <View className="flex-row items-center justify-between">
          <View className="flex-row items-center flex-1">
            <View className="bg-white/20 p-2 rounded-full mr-3">
              <Ionicons
                name={assignment.autoGenerated ? "flash" : "hand-left"}
                size={20}
                color="#fff"
              />
            </View>
            <View className="flex-1">
              <Text
                style={{
                  fontFamily: "Poppins",
                  fontSize: 14,
                  fontWeight: "700",
                  color: "#fff",
                }}
              >
                {assignment.shiftName || "Active Shift"}
              </Text>
              <Text
                style={{
                  fontFamily: "Poppins",
                  fontSize: 11,
                  color: "#fff",
                  opacity: 0.9,
                }}
              >
                {assignment.autoGenerated ? "Auto-assigned" : "Manual override"}
              </Text>
            </View>
          </View>
          <View className="flex-row items-center">
            {activeTrip && (
              <View className="bg-white/30 px-2 py-1 rounded-full mr-2">
                <Text
                  style={{
                    fontFamily: "Poppins",
                    fontSize: 10,
                    color: "#fff",
                    fontWeight: "600",
                  }}
                >
                  LIVE
                </Text>
              </View>
            )}
            <Ionicons
              name={expanded ? "chevron-up" : "chevron-down"}
              size={20}
              color="#fff"
            />
          </View>
        </View>
      </LinearGradient>

      {/* Content */}
      <View className="p-4">
        {/* Driver Info */}
        <View className="flex-row items-center mb-3">
          <View className="bg-blue-100 p-2 rounded-full">
            <Ionicons
              name={assignment.drivers?.length > 1 ? "people" : "person-circle"}
              size={20}
              color="#3B82F6"
            />
          </View>
          <View className="ml-3 flex-1">
            <Text
              style={{
                fontFamily: "Poppins",
                fontSize: 13,
                fontWeight: "600",
                color: "#1F2937",
              }}
            >
              {getDriverNames(assignment)}
            </Text>
            {assignment.drivers?.length > 1 && (
              <Text
                style={{
                  fontFamily: "Poppins",
                  fontSize: 11,
                  color: "#6B7280",
                }}
              >
                {assignment.drivers.length} drivers assigned
              </Text>
            )}
          </View>
        </View>

        {/* Truck Info */}
        <View className="flex-row items-center mb-3">
          <View className="bg-purple-100 p-2 rounded-full">
            <Ionicons name="car-sport" size={20} color="#8B5CF6" />
          </View>
          <View className="ml-3 flex-1">
            <Text
              style={{
                fontFamily: "Poppins",
                fontSize: 13,
                fontWeight: "600",
                color: "#1F2937",
              }}
            >
              {assignment.truck?.registrationNumber || "N/A"}
            </Text>
            <Text
              style={{
                fontFamily: "Poppins",
                fontSize: 11,
                color: "#6B7280",
              }}
            >
              {assignment.truck?.model || "Model N/A"}
            </Text>
          </View>
        </View>

        {/* Active Trip Section */}
        {activeTrip && (
          <View className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-3 mb-3">
            <View className="flex-row items-center mb-2">
              <Ionicons name="navigate-circle" size={20} color="#4F46E5" />
              <Text
                style={{
                  fontFamily: "Poppins",
                  fontSize: 12,
                  fontWeight: "700",
                  color: "#4F46E5",
                  marginLeft: 6,
                }}
              >
                ACTIVE TRIP
              </Text>
            </View>
            <View className="flex-row items-start justify-between">
              <View className="flex-1 pr-2">
                <Text
                  style={{
                    fontFamily: "Poppins",
                    fontSize: 11,
                    color: "#6B7280",
                  }}
                >
                  Destination
                </Text>
                <Text
                  style={{
                    fontFamily: "Poppins",
                    fontSize: 12,
                    fontWeight: "600",
                    color: "#1F2937",
                  }}
                  numberOfLines={1}
                >
                  {getLocationLabel(activeTrip.endLocation)}
                </Text>
                <Text
                  style={{
                    fontFamily: "Poppins",
                    fontSize: 10,
                    color: "#9CA3AF",
                    marginTop: 2,
                  }}
                >
                  Started {formatTimeValue(activeTrip.startTime)}
                </Text>
              </View>
              <TripStatusBadge status={activeTrip.status} />
            </View>
          </View>
        )}

        {/* Trip Statistics */}
        <View className="flex-row items-center justify-between bg-gray-50 rounded-xl p-3 mb-3">
          <View className="items-center flex-1">
            <Text
              style={{
                fontFamily: "Poppins",
                fontSize: 20,
                fontWeight: "700",
                color: "#D4AF37",
              }}
            >
              {assignment.tripCount || assignment.trips?.length || 0}
            </Text>
            <Text
              style={{
                fontFamily: "Poppins",
                fontSize: 10,
                color: "#6B7280",
              }}
            >
              Total Trips
            </Text>
          </View>
          <View className="w-px h-10 bg-gray-300" />
          <View className="items-center flex-1">
            <Text
              style={{
                fontFamily: "Poppins",
                fontSize: 20,
                fontWeight: "700",
                color: "#10B981",
              }}
            >
              {assignment.trips?.filter((t) => t.status === "completed")
                .length || 0}
            </Text>
            <Text
              style={{
                fontFamily: "Poppins",
                fontSize: 10,
                color: "#6B7280",
              }}
            >
              Completed
            </Text>
          </View>
          <View className="w-px h-10 bg-gray-300" />
          <View className="items-center flex-1">
            <Text
              style={{
                fontFamily: "Poppins",
                fontSize: 20,
                fontWeight: "700",
                color: "#3B82F6",
              }}
            >
              {assignment.trips?.filter((t) => t.status === "in-progress")
                .length || 0}
            </Text>
            <Text
              style={{
                fontFamily: "Poppins",
                fontSize: 10,
                color: "#6B7280",
              }}
            >
              Active
            </Text>
          </View>
        </View>

        {/* Expanded Trip List */}
        {expanded && assignment.trips && assignment.trips.length > 0 && (
          <View className="mt-2">
            <Text
              style={{
                fontFamily: "Poppins",
                fontSize: 12,
                fontWeight: "600",
                color: "#1F2937",
                marginBottom: 8,
              }}
            >
              Recent Trips
            </Text>
            {assignment.trips.slice(0, 5).map((trip, index) => (
              <View
                key={trip._id}
                className="flex-row items-start justify-between mb-3 pb-3 border-b border-gray-100"
              >
                <View className="flex-1 pr-3">
                  <View className="flex-row items-center mb-1">
                    <View
                      className="w-2 h-2 rounded-full mr-2"
                      style={{
                        backgroundColor:
                          trip.status === "completed"
                            ? "#10B981"
                            : trip.status === "in-progress"
                              ? "#3B82F6"
                              : "#F59E0B",
                      }}
                    />
                    <Text
                      style={{
                        fontFamily: "Poppins",
                        fontSize: 11,
                        fontWeight: "600",
                        color: "#374151",
                      }}
                      numberOfLines={1}
                    >
                      {getLocationLabel(trip.startLocation)}
                    </Text>
                  </View>
                  <View className="flex-row items-center ml-4">
                    <Ionicons name="arrow-forward" size={10} color="#9CA3AF" />
                    <Text
                      style={{
                        fontFamily: "Poppins",
                        fontSize: 11,
                        color: "#6B7280",
                        marginLeft: 4,
                      }}
                      numberOfLines={1}
                    >
                      {getLocationLabel(trip.endLocation)}
                    </Text>
                  </View>
                  <Text
                    style={{
                      fontFamily: "Poppins",
                      fontSize: 9,
                      color: "#9CA3AF",
                      marginTop: 2,
                      marginLeft: 16,
                    }}
                  >
                    {trip.estimatedDistance
                      ? `${trip.estimatedDistance} km`
                      : "Distance TBD"}{" "}
                    • {formatTimeValue(trip.startTime)}
                  </Text>
                </View>
                <TripStatusBadge status={trip.status} />
              </View>
            ))}
            {assignment.trips.length > 5 && (
              <Text
                style={{
                  fontFamily: "Poppins",
                  fontSize: 11,
                  color: "#6B7280",
                  textAlign: "center",
                }}
              >
                +{assignment.trips.length - 5} more trip(s)
              </Text>
            )}
          </View>
        )}

        {/* Action Buttons */}
        <View className="flex-row mt-3 gap-2">
          <TouchableOpacity
            onPress={() => setExpanded(!expanded)}
            className="flex-1 bg-gray-100 py-3 rounded-xl flex-row items-center justify-center"
          >
            <Ionicons
              name={expanded ? "chevron-up" : "eye-outline"}
              size={16}
              color="#374151"
            />
            <Text
              style={{
                fontFamily: "Poppins",
                fontSize: 12,
                fontWeight: "600",
                color: "#374151",
                marginLeft: 6,
              }}
            >
              {expanded ? "Show Less" : "View Details"}
            </Text>
          </TouchableOpacity>
          <TouchableOpacity
            onPress={() => onRelease(assignment._id)}
            className="flex-1 bg-red-50 py-3 rounded-xl flex-row items-center justify-center"
          >
            <Ionicons name="close-circle-outline" size={16} color="#DC2626" />
            <Text
              style={{
                fontFamily: "Poppins",
                fontSize: 12,
                fontWeight: "600",
                color: "#DC2626",
                marginLeft: 6,
              }}
            >
              Release Shift
            </Text>
          </TouchableOpacity>
        </View>
      </View>
    </TouchableOpacity>
  );
};

export default function ShiftAssignments() {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [refreshing, setRefreshing] = useState(false);
  const [activeAssignments, setActiveAssignments] = useState([]);
  const [availableTrucks, setAvailableTrucks] = useState([]);
  const [drivers, setDrivers] = useState([]);
  const [shiftSchedules, setShiftSchedules] = useState([]);
  const [currentShift, setCurrentShift] = useState(null);
  const [showManualModal, setShowManualModal] = useState(false);

  // Manual assignment form
  const [selectedDriver, setSelectedDriver] = useState("");
  const [selectedTruck, setSelectedTruck] = useState("");

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      setLoading(true);
      const [assignmentsRes, trucksRes, driversRes, schedulesRes] =
        await Promise.all([
          AutoShiftService.getActiveAssignments(),
          AutoShiftService.getAvailableTrucks(),
          apiClient.get("/drivers"),
          AutoShiftService.getShiftSchedules(),
        ]);

      if (assignmentsRes.success) {
        setActiveAssignments(assignmentsRes.data || []);
      }

      if (trucksRes.success) {
        setAvailableTrucks(trucksRes.data || []);
      }

      if (driversRes.success) {
        setDrivers(driversRes.data || []);
      }

      if (schedulesRes.success) {
        setShiftSchedules(schedulesRes.data.schedules || []);
        setCurrentShift(schedulesRes.data.current);
      }
    } catch (error) {
      Toast.show({
        type: "error",
        text1: "Error",
        text2: error.message || "Failed to load data",
      });
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };

  const handleManualAssign = async () => {
    if (!selectedDriver || !selectedTruck) {
      Toast.show({
        type: "error",
        text1: "Validation Error",
        text2: "Please select both driver and truck",
      });
      return;
    }

    try {
      setLoading(true);
      const response = await AutoShiftService.manualAssignTruck(
        selectedDriver,
        selectedTruck
      );

      if (response.success) {
        Toast.show({
          type: "success",
          text1: "Success",
          text2: "Truck assigned successfully",
        });
        setShowManualModal(false);
        setSelectedDriver("");
        setSelectedTruck("");
        loadData();
      } else {
        Toast.show({
          type: "error",
          text1: "Error",
          text2: response.message || "Failed to assign truck",
        });
      }
    } catch (error) {
      Toast.show({
        type: "error",
        text1: "Error",
        text2: error.message || "Failed to assign truck",
      });
    } finally {
      setLoading(false);
    }
  };

  const handleReleaseShift = async (shiftId) => {
    try {
      setLoading(true);
      const response = await AutoShiftService.releaseShift(shiftId);

      if (response.success) {
        Toast.show({
          type: "success",
          text1: "Success",
          text2: "Shift released successfully",
        });
        loadData();
      } else {
        Toast.show({
          type: "error",
          text1: "Error",
          text2: response.message || "Failed to release shift",
        });
      }
    } catch (error) {
      Toast.show({
        type: "error",
        text1: "Error",
        text2: error.message || "Failed to release shift",
      });
    } finally {
      setLoading(false);
    }
  };

  const onRefresh = () => {
    setRefreshing(true);
    loadData();
  };

  if (loading && !refreshing) {
    return (
      <SafeAreaView className="flex-1 bg-gray-50">
        <View className="flex-1 justify-center items-center">
          <ActivityIndicator size="large" color="#D4AF37" />
          <Text
            className="text-gray-600 mt-4"
            style={{ fontFamily: "Poppins" }}
          >
            Loading shift data...
          </Text>
        </View>
      </SafeAreaView>
    );
  }

  return (
    <SafeAreaView className="flex-1 bg-gray-50">
      {/* Header */}
      <View className="bg-white px-6 py-4 shadow-sm">
        <View className="flex-row items-center justify-between">
          <View className="flex-row items-center flex-1">
            <TouchableOpacity onPress={() => router.back()} className="mr-4">
              <Ionicons name="arrow-back" size={24} color="#1F2937" />
            </TouchableOpacity>
            <View>
              <Text
                style={{
                  fontFamily: "Cinzel",
                  fontSize: 24,
                  fontWeight: "700",
                  color: "#1F2937",
                }}
              >
                Shift Management
              </Text>
              <Text
                style={{
                  fontFamily: "Poppins",
                  fontSize: 12,
                  color: "#6B7280",
                }}
              >
                Real-time assignments & tracking
              </Text>
            </View>
          </View>
          <TouchableOpacity
            onPress={() => setShowManualModal(true)}
            className="bg-[#D4AF37] p-3 rounded-full shadow-sm"
          >
            <Ionicons name="add" size={24} color="#fff" />
          </TouchableOpacity>
        </View>
      </View>

      <ScrollView
        className="flex-1"
        refreshControl={
          <RefreshControl
            refreshing={refreshing}
            onRefresh={onRefresh}
            tintColor="#D4AF37"
          />
        }
      >
        <View className="p-6">
          {/* Current Shift Banner */}
          {currentShift && (
            <LinearGradient
              colors={["#10B981", "#059669"]}
              start={{ x: 0, y: 0 }}
              end={{ x: 1, y: 1 }}
              className="rounded-2xl p-5 mb-6 shadow-lg"
            >
              <View className="flex-row items-center mb-3">
                <View className="w-3 h-3 rounded-full bg-white animate-pulse mr-3" />
                <Text
                  style={{
                    fontFamily: "Poppins",
                    fontSize: 12,
                    color: "#fff",
                    fontWeight: "600",
                    opacity: 0.9,
                  }}
                >
                  ACTIVE SHIFT
                </Text>
              </View>
              <Text
                style={{
                  fontFamily: "Cinzel",
                  fontSize: 22,
                  fontWeight: "700",
                  color: "#fff",
                  marginBottom: 8,
                }}
              >
                {currentShift.name}
              </Text>
              <View className="flex-row items-center">
                <Ionicons name="time-outline" size={16} color="#fff" />
                <Text
                  style={{
                    fontFamily: "Poppins",
                    fontSize: 14,
                    color: "#fff",
                    marginLeft: 6,
                  }}
                >
                  {currentShift.startHour}:
                  {String(currentShift.startMinute).padStart(2, "0")} -{" "}
                  {currentShift.endHour}:
                  {String(currentShift.endMinute).padStart(2, "0")} IST
                </Text>
              </View>
            </LinearGradient>
          )}

          {/* Statistics Cards */}
          <View className="flex-row mb-6">
            <StatCard
              icon="briefcase"
              label="Active"
              value={activeAssignments.length}
              gradientColors={["#3B82F6", "#2563EB"]}
            />
            <StatCard
              icon="car-sport"
              label="Available"
              value={availableTrucks.length}
              gradientColors={["#10B981", "#059669"]}
            />
            <StatCard
              icon="people"
              label="Drivers"
              value={drivers.length}
              gradientColors={["#F59E0B", "#D97706"]}
            />
          </View>

          {/* Active Assignments */}
          <View className="mb-6">
            <View className="flex-row items-center justify-between mb-4">
              <Text
                style={{
                  fontFamily: "Poppins",
                  fontSize: 18,
                  fontWeight: "700",
                  color: "#1F2937",
                }}
              >
                Active Assignments
              </Text>
              {activeAssignments.length > 0 && (
                <View className="bg-blue-100 px-3 py-1 rounded-full">
                  <Text
                    style={{
                      fontFamily: "Poppins",
                      fontSize: 12,
                      fontWeight: "600",
                      color: "#2563EB",
                    }}
                  >
                    {activeAssignments.length} active
                  </Text>
                </View>
              )}
            </View>

            {activeAssignments.length === 0 ? (
              <View className="bg-white rounded-2xl p-10 items-center shadow-sm">
                <View className="bg-gray-100 p-6 rounded-full mb-4">
                  <Ionicons name="car-outline" size={48} color="#9CA3AF" />
                </View>
                <Text
                  style={{
                    fontFamily: "Poppins",
                    fontSize: 16,
                    fontWeight: "600",
                    color: "#374151",
                    marginBottom: 8,
                  }}
                >
                  No Active Assignments
                </Text>
                <Text
                  style={{
                    fontFamily: "Poppins",
                    fontSize: 13,
                    color: "#9CA3AF",
                    textAlign: "center",
                  }}
                >
                  Assign drivers and trucks to get started
                </Text>
              </View>
            ) : (
              activeAssignments.map((assignment) => (
                <AssignmentCard
                  key={assignment._id}
                  assignment={assignment}
                  onRelease={handleReleaseShift}
                />
              ))
            )}
          </View>

          {/* Available Trucks */}
          {availableTrucks.length > 0 && (
            <View>
              <View className="flex-row items-center justify-between mb-4">
                <Text
                  style={{
                    fontFamily: "Poppins",
                    fontSize: 18,
                    fontWeight: "700",
                    color: "#1F2937",
                  }}
                >
                  Available Trucks
                </Text>
                <View className="bg-green-100 px-3 py-1 rounded-full">
                  <Text
                    style={{
                      fontFamily: "Poppins",
                      fontSize: 12,
                      fontWeight: "600",
                      color: "#059669",
                    }}
                  >
                    {availableTrucks.length} ready
                  </Text>
                </View>
              </View>

              {availableTrucks.map((truck) => (
                <View
                  key={truck._id}
                  className="bg-white rounded-xl p-4 mb-3 flex-row items-center shadow-sm"
                >
                  <View className="bg-green-100 p-3 rounded-full">
                    <Ionicons name="car-sport" size={22} color="#10B981" />
                  </View>
                  <View className="ml-4 flex-1">
                    <Text
                      style={{
                        fontFamily: "Poppins",
                        fontSize: 14,
                        fontWeight: "600",
                        color: "#1F2937",
                      }}
                    >
                      {truck.registrationNumber}
                    </Text>
                    <Text
                      style={{
                        fontFamily: "Poppins",
                        fontSize: 12,
                        color: "#6B7280",
                      }}
                    >
                      {truck.model}
                    </Text>
                  </View>
                  <View className="bg-green-50 px-3 py-2 rounded-full">
                    <Text
                      style={{
                        fontFamily: "Poppins",
                        fontSize: 11,
                        fontWeight: "600",
                        color: "#059669",
                      }}
                    >
                      AVAILABLE
                    </Text>
                  </View>
                </View>
              ))}
            </View>
          )}
        </View>
      </ScrollView>

      {/* Manual Assignment Modal */}
      <Modal
        visible={showManualModal}
        animationType="slide"
        transparent={true}
        onRequestClose={() => setShowManualModal(false)}
      >
        <View className="flex-1 bg-black/50 justify-end">
          <View className="bg-white rounded-t-3xl p-6">
            <View className="flex-row items-center justify-between mb-6">
              <Text
                style={{
                  fontFamily: "Poppins",
                  fontSize: 20,
                  fontWeight: "700",
                  color: "#1F2937",
                }}
              >
                Manual Assignment
              </Text>
              <TouchableOpacity
                onPress={() => setShowManualModal(false)}
                className="bg-gray-100 p-2 rounded-full"
              >
                <Ionicons name="close" size={24} color="#374151" />
              </TouchableOpacity>
            </View>

            {/* Driver Picker */}
            <View className="mb-4">
              <Text
                style={{
                  fontFamily: "Poppins",
                  fontSize: 14,
                  fontWeight: "600",
                  color: "#374151",
                  marginBottom: 8,
                }}
              >
                Select Driver
              </Text>
              <View className="border-2 border-gray-200 rounded-xl overflow-hidden">
                <Picker
                  selectedValue={selectedDriver}
                  onValueChange={(value) => setSelectedDriver(value)}
                  style={{ fontFamily: "Poppins" }}
                >
                  <Picker.Item
                    label="-- Choose a driver --"
                    value=""
                    style={{ fontFamily: "Poppins" }}
                  />
                  {drivers.map((driver) => (
                    <Picker.Item
                      key={driver._id}
                      label={`${driver.name} • ${driver.email}`}
                      value={driver._id}
                      style={{ fontFamily: "Poppins" }}
                    />
                  ))}
                </Picker>
              </View>
            </View>

            {/* Truck Picker */}
            <View className="mb-6">
              <Text
                style={{
                  fontFamily: "Poppins",
                  fontSize: 14,
                  fontWeight: "600",
                  color: "#374151",
                  marginBottom: 8,
                }}
              >
                Select Truck
              </Text>
              <View className="border-2 border-gray-200 rounded-xl overflow-hidden">
                <Picker
                  selectedValue={selectedTruck}
                  onValueChange={(value) => setSelectedTruck(value)}
                  style={{ fontFamily: "Poppins" }}
                >
                  <Picker.Item
                    label="-- Choose a truck --"
                    value=""
                    style={{ fontFamily: "Poppins" }}
                  />
                  {availableTrucks.map((truck) => (
                    <Picker.Item
                      key={truck._id}
                      label={`${truck.registrationNumber} • ${truck.model}`}
                      value={truck._id}
                      style={{ fontFamily: "Poppins" }}
                    />
                  ))}
                </Picker>
              </View>
            </View>

            {/* Action Buttons */}
            <View className="flex-row gap-3">
              <TouchableOpacity
                onPress={() => setShowManualModal(false)}
                className="flex-1 bg-gray-100 py-4 rounded-xl items-center"
              >
                <Text
                  style={{
                    fontFamily: "Poppins",
                    fontSize: 14,
                    fontWeight: "600",
                    color: "#374151",
                  }}
                >
                  Cancel
                </Text>
              </TouchableOpacity>
              <TouchableOpacity
                onPress={handleManualAssign}
                className="flex-1 bg-[#D4AF37] py-4 rounded-xl items-center"
                disabled={loading || !selectedDriver || !selectedTruck}
                style={{
                  opacity:
                    loading || !selectedDriver || !selectedTruck ? 0.5 : 1,
                }}
              >
                {loading ? (
                  <ActivityIndicator color="#fff" />
                ) : (
                  <Text
                    style={{
                      fontFamily: "Poppins",
                      fontSize: 14,
                      fontWeight: "600",
                      color: "#fff",
                    }}
                  >
                    Assign Now
                  </Text>
                )}
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    </SafeAreaView>
  );
}
